<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      /* Dark Theme Palette */
      --primary: #6366f1; /* Indigo Accent */
      --primary-hover: #4f46e5;
      --secondary: #ec4899; /* Pink for Friend Mode */
      --danger: #ef4444;
      
      --bg-color: #0f172a;   
      --card-bg: #1e293b;    
      --input-bg: #334155;
      
      --text-main: #f8fafc;  
      --text-muted: #94a3b8; 
      --border-color: #334155;
      
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    /* --- LAYOUT --- */
    .main-wrapper {
      width: 100%;
      max-width: 1200px;
      padding: 40px 20px;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
    }

    /* --- SIDEBAR (FORM) --- */
    .sidebar { display: flex; flex-direction: column; gap: 20px; }

    .card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    h1 { font-size: 24px; font-weight: 700; margin: 0 0 5px 0; color: var(--primary); }
    h2 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }
    p.subtitle { color: var(--text-muted); font-size: 14px; margin: 0 0 20px 0; }

    /* --- TABS --- */
    .tab-container {
      display: flex;
      background: var(--input-bg);
      padding: 5px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: var(--card-bg); /* Pop out effect */
      color: var(--text-main);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .tab-btn.friend-active {
        color: var(--secondary);
    }

    /* --- INPUTS --- */
    .form-group { margin-bottom: 15px; }
    
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: var(--input-bg);
      color: white;
    }

    input::placeholder { color: #64748b; }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

    /* Hide helper class */
    .hidden { display: none; }

    /* --- BUTTONS --- */
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }

    .btn-secondary { background: var(--secondary); color: white; }
    .btn-secondary:hover { opacity: 0.9; transform: translateY(-2px); }

    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
    .btn-outline:hover { background: var(--input-bg); color: white; }

    /* --- DASHBOARD & TABLE --- */
    .dashboard { display: flex; flex-direction: column; gap: 20px; }

    .total-card {
      background: linear-gradient(135deg, #4f46e5 0%, #a855f7 100%);
      color: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-info h3 { margin: 0; font-weight: 400; opacity: 0.9; font-size: 16px; }
    .total-amount { font-size: 36px; font-weight: 700; margin: 5px 0 0 0; }
    .total-icon { font-size: 40px; opacity: 0.3; }

    /* FILTERS & TABLE */
    .filter-container { display: flex; gap: 10px; align-items: center; }
    .filter-container input { flex: 1; }
    .filter-container button { width: auto; padding: 10px 20px; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    th { text-align: left; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding: 0 20px; }
    
    tbody tr { background: var(--input-bg); transition: transform 0.2s; }
    tbody tr:hover { transform: scale(1.01); background: #475569; }
    
    td { padding: 20px; border-top: 1px solid var(--bg-color); border-bottom: 1px solid var(--bg-color); color: var(--text-main); }
    td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; border-left: 1px solid var(--bg-color); font-weight: bold; color: var(--primary); }
    td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-right: 1px solid var(--bg-color); text-align: right; }

    .category-tag { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid rgba(99, 102, 241, 0.3); }
    /* Special style for Friend tag */
    .tag-friend { background: rgba(236, 72, 153, 0.2); color: #f472b6; border-color: rgba(236, 72, 153, 0.3); }

    .amount-text { font-weight: bold; color: #34d399; }
    .delete-btn { background: rgba(239, 68, 68, 0.2); color: var(--danger); width: 35px; height: 35px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
    .delete-btn:hover { background: var(--danger); color: white; }

    @media (max-width: 900px) {
      .main-wrapper { grid-template-columns: 1fr; }
      .total-card { flex-direction: column; align-items: flex-start; gap: 15px; }
      .total-icon { display: none; }
    }
  </style>
</head>
<body>

  <div class="main-wrapper">
    
    <aside class="sidebar">
      <div class="card">
        <h1>Expense Tracker</h1>
        <p class="subtitle">Manage finances & friends</p>
        
        <div class="tab-container">
          <button class="tab-btn active" id="tab-expense" onclick="switchMode('expense')">Expense</button>
          <button class="tab-btn" id="tab-friend" onclick="switchMode('friend')">Lend Friend</button>
        </div>
        
        <div class="form-group" id="input-category-group">
          <label>Category</label>
          <input type="text" id="category" placeholder="e.g. Food, Travel">
        </div>

        <div class="form-group hidden" id="input-friend-group">
          <label style="color: var(--secondary)">Friend Name</label>
          <input type="text" id="friendName" placeholder="Who did you give money?">
        </div>
        
        <div class="form-group">
          <label>Amount (₹)</label>
          <input type="number" id="amount" placeholder="0.00">
        </div>
        
        <div class="form-group">
          <label>Note</label>
          <input type="text" id="note" placeholder="Description (optional)">
        </div>

        <button class="btn-primary" id="submit-btn" onclick="submitForm()">Add Transaction</button>
      </div>
    </aside>

    <main class="dashboard">
      
      <div class="total-card">
        <div class="total-info">
          <h3>Total Balance / Spending</h3>
          <div class="total-amount" id="total">₹0.00</div>
        </div>
        <i class="fa-solid fa-wallet total-icon"></i>
      </div>

      <div class="card">
        <div class="filter-container">
          <input type="text" id="filterCategory" placeholder="Search by Category...">
          <button class="btn-outline" onclick="getExpenses()"><i class="fa-solid fa-filter"></i> Filter</button>
          <button class="btn-outline" onclick="getExpenses(true)"><i class="fa-solid fa-rotate-right"></i></button>
        </div>

        <div class="table-container">
          <table id="expensesTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Category</th>
                <th>Note</th>
                <th>Amount</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:8000";
    let currentMode = 'expense'; // 'expense' or 'friend'

    // Currency Formatter
    const formatCurrency = (num) => {
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(num);
    }

    // --- TAB SWITCHING LOGIC ---
    function switchMode(mode) {
      currentMode = mode;
      
      const expenseTab = document.getElementById('tab-expense');
      const friendTab = document.getElementById('tab-friend');
      const catGroup = document.getElementById('input-category-group');
      const friendGroup = document.getElementById('input-friend-group');
      const btn = document.getElementById('submit-btn');

      if (mode === 'expense') {
        expenseTab.classList.add('active');
        friendTab.classList.remove('active', 'friend-active');
        catGroup.classList.remove('hidden');
        friendGroup.classList.add('hidden');
        
        btn.innerText = "Add Transaction";
        btn.className = "btn-primary";
      } else {
        friendTab.classList.add('active', 'friend-active');
        expenseTab.classList.remove('active');
        catGroup.classList.add('hidden');
        friendGroup.classList.remove('hidden');
        
        btn.innerText = "Record Loan";
        btn.className = "btn-secondary"; // Make button pink
      }
    }

    // --- API CALLS ---

    async function submitForm() {
      const amount = document.getElementById("amount").value;
      const note = document.getElementById("note").value;

      if (!amount) { alert("Please enter amount"); return; }

      if (currentMode === 'expense') {
        // --- EXPENSE LOGIC ---
        const category = document.getElementById("category").value;
        if (!category) { alert("Please enter category"); return; }

        try {
          await fetch(`${API_URL}/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ category, amount: Number(amount), note })
          });
          clearInputs();
          getExpenses();
        } catch (err) { alert("Error adding expense"); }

      } else {
        // --- FRIEND LOGIC (/give) ---
        const friendName = document.getElementById("friendName").value;
        if (!friendName) { alert("Please enter friend's name"); return; }

        try {
          await fetch(`${API_URL}/give`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ friend_name: friendName, amount: Number(amount), note })
          });
          clearInputs();
          getExpenses();
        } catch (err) { alert("Error recording friend transaction"); }
      }
    }

    function clearInputs() {
      document.getElementById("category").value = "";
      document.getElementById("friendName").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("note").value = "";
    }

    async function getExpenses(reset=false) {
      if(reset) document.getElementById("filterCategory").value = "";
      let category = document.getElementById("filterCategory").value;
      let url = `${API_URL}/entries`;
      if (category && !reset) url += `?category=${category}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const tbody = document.querySelector("#expensesTable tbody");
        tbody.innerHTML = "";

        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#555; padding: 30px;">No records found</td></tr>`;
        }

        data.forEach(e => {
          // Check if it's a Friend category to style differently
          let tagClass = "category-tag";
          if (e.category === "Friend") tagClass += " tag-friend";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>#${e.id}</td>
            <td><span class="${tagClass}">${e.category}</span></td>
            <td style="color: #94a3b8;">${e.note}</td>
            <td class="amount-text">${formatCurrency(e.amount)}</td>
            <td>
              <button class="delete-btn" onclick="deleteExpense(${e.id})"><i class="fa-solid fa-trash"></i></button>
            </td>
          `;
          tbody.appendChild(row);
        });
        getTotal(); 
      } catch (err) { console.error("Error fetching expenses:", err); }
    }

    async function getTotal() {
      try {
        const res = await fetch(`${API_URL}/total`);
        const data = await res.json();
        document.getElementById("total").innerText = formatCurrency(data.total_spending);
      } catch (err) { console.error("Error fetching total:", err); }
    }

    async function deleteExpense(id) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      try { await fetch(`${API_URL}/entry/${id}`, { method: "DELETE" }); getExpenses(); } 
      catch (err) { alert("Error deleting entry"); }
    }

    // Initial load
    getExpenses();
  </script>
</body>
</html>